<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>CrisisConnect | Disaster Command Center</title>
    
    <!-- Fonts (Optional: System fonts used as fallback) -->
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> -->
    
    <!-- Dependencies (Local Offline Support) -->
    <script src="js/sockjs.min.js"></script>
    <script src="js/stomp.min.js"></script>
    
    <!-- App Styles & Offline Icons -->
    <script src="js/qrcode.min.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/offline-icons.css">
    <link rel="manifest" href="manifest.json">

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => {
                        console.log('SW registered');
                        reg.update(); // Force update
                    })
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo-area">
                <img src="images/logo.png" alt="CrisisConnect Logo" class="logo-icon" style="height: 40px; width: 40px;">
                <span class="logo-text">CrisisConnect</span>
            </div>
            
            <div class="header-stats">
                <div class="stat-item">
                    <div class="stat-value" id="statUsers">0</div>
                    <div class="stat-label"><i class="ph-bold ph-users-three"></i> Active</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statMessages">0</div>
                    <div class="stat-label"><i class="ph-bold ph-chat-centered-text"></i> Messages</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statCritical" style="color: var(--danger-color)">0</div>
                    <div class="stat-label"><i class="ph-bold ph-warning-circle"></i> Critical</div>
                </div>
            </div>

            <div class="header-controls" style="display: flex; gap: 1rem; align-items: center;">
                <button id="btnShowQR" class="btn btn-sm" style="background: var(--accent-color); color: white; display: none;"><i class="ph-bold ph-qr-code"></i> Connect Devices</button>
                <button id="btnClearChat" class="btn btn-sm" style="display: none;"><i class="ph-bold ph-trash"></i> Clear</button>
                <button id="btnConnect" class="btn btn-sm" style="display: none;"><i class="ph-bold ph-plug"></i> Connect</button>
                <button id="btnDisconnect" class="btn btn-sm btn-danger" style="display: none;"><i class="ph-bold ph-plugs"></i> Disconnect</button>
                <div class="connection-badge disconnected" id="connectionStatus">
                    <span class="indicator"></span> Offline
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="app-sidebar">
            <div class="my-status-card card">
                <div class="section-title"><i class="ph-bold ph-user-focus"></i> My Status</div>
                <div class="status-selector">
                    <select id="myStatus">
                        <option value="SAFE">Safe & Secure</option>
                        <option value="NEED_HELP">Need Assistance</option>
                        <option value="INJURED">Medical Emergency</option>
                        <option value="CRITICAL">Critical Danger</option>
                    </select>
                </div>
            </div>

            <div class="status-feed">
                <div class="section-title"><i class="ph-bold ph-broadcast"></i> Network Feed</div>
                <div class="status-list" id="statusList">
                    <!-- Status items injected here -->
                </div>
            </div>
        </aside>

        <!-- Sidebar Footer (Settings) -->
        <div class="sidebar-footer" style="position: absolute; bottom: 0; left: 0; width: 320px; padding: 1rem; background: rgba(30, 41, 59, 0.95); border-top: 1px solid var(--glass-border); display: flex; gap: 0.5rem; z-index: 10;">
            <button id="btnSettings" class="btn btn-sm" style="width: 100%; background: transparent; border: 1px solid var(--glass-border);">
                <i class="ph-bold ph-gear"></i> Settings
            </button>
        </div>

        <!-- Main Chat Area -->
        <main class="chat-area">
            <div class="messages-container" id="messagesContainer">
                <div class="empty-state" style="margin: auto; text-align: center; color: var(--text-secondary); opacity: 0.5;">
                    <i class="ph-duotone ph-chat-circle-dots" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                    <p>No messages yet. Start the conversation.</p>
                </div>
                <!-- Messages injected here -->
            </div>

                <!-- Quick Replies -->
            <div class="quick-replies" id="quickReplies">
                <button class="chip" data-msg="I am Safe">Safe</button>
                <button class="chip" data-msg="Need Water">Need Water</button>
                <button class="chip" data-msg="Need Food">Need Food</button>
                <button class="chip" data-msg="Need Medical Help">Medical Help</button>
                <button class="chip" data-msg="Where is shelter?">Shelter?</button>
                <button class="chip" data-msg="Location Shared">Share Location</button>
            </div>

            <div class="input-zone">
                    <div class="input-row">
                        <div class="input-wrapper" style="flex: 0 0 auto; min-width: 120px;">
                             <i class="ph-bold ph-user input-icon"></i>
                             <input type="text" id="userNameInput" class="input-field has-icon" placeholder="Name/ID" autocomplete="off">
                        </div>
                        <div class="input-wrapper" style="flex:1;">
                            <i class="ph-bold ph-paper-plane-right input-icon"></i>
                            <input type="text" id="messageInput" class="input-field has-icon" placeholder="Type a message..." autocomplete="off">
                        </div>
                        <button class="btn btn-icon" id="btnShareLoc" title="Share Location"><i class="ph-bold ph-map-pin"></i></button>
                        <button class="btn btn-icon" id="btnSend"><i class="ph-bold ph-arrow-right"></i></button>
                        <button class="btn btn-danger btn-icon" id="btnSOS" title="Send SOS"><i class="ph-bold ph-warning"></i></button>
                    </div>
                </div>
        </main>
    </div>

    <!-- Location Input Modal -->
    <div id="locationModal" class="modal" style="display: none;">
        <div class="modal-content card">
            <h3 class="section-title" style="font-size: 1rem; margin-bottom: 1rem;">Share Location Details</h3>
            <div class="input-wrapper" style="margin-bottom: 1rem;">
                <i class="ph-bold ph-map-pin input-icon"></i>
                <input type="text" id="manualLocationInput" class="input-field has-icon" placeholder="Describe your location (e.g. 'Red House, Roof')..." autocomplete="off">
            </div>
            <div class="modal-actions" style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button id="btnCancelLoc" class="btn btn-sm" style="background: transparent; border: 1px solid var(--glass-border);">Cancel</button>
                <button id="btnConfirmLoc" class="btn btn-sm">Share Location</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" style="display: none;">
        <div class="modal-content card">
            <h3 class="section-title" style="font-size: 1rem; margin-bottom: 1.5rem;">Settings & Profile</h3>
            
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Your Role</label>
                <div class="status-selector">
                    <select id="userRole">
                        <option value="Citizen">Citizen</option>
                        <option value="Volunteer">Volunteer</option>
                        <option value="Responder">First Responder</option>
                        <option value="Medic">Medical Professional</option>
                        <option value="Dispatcher">Dispatcher</option>
                    </select>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                <label style="font-size: 0.9rem; color: var(--text-secondary);">Enable Notifications</label>
                <label class="switch">
                    <input type="checkbox" id="toggleNotifications">
                    <span class="slider round"></span>
                </label>
            </div>

            <div class="user-info-display" style="padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem; margin-bottom: 1.5rem;">
               <div style="font-size: 0.8rem; color: var(--text-secondary);">Your ID</div>
               <div style="font-family: monospace; color: var(--accent-color);" id="displayUserId">...</div>
            </div>

            <button id="btnCloseSettings" class="btn btn-sm" style="width: 100%;">Save & Close</button>
        </div>
    </div>

    <!-- Profile View Modal -->
    <div id="profileModal" class="modal" style="display: none;">
        <div class="modal-content card">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="width: 60px; height: 60px; background: var(--items-bg); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--accent-color);">
                    <i class="ph-bold ph-user"></i>
                </div>
                <h3 id="profileName" style="font-size: 1.2rem; font-weight: bold;">User Name</h3>
                <div id="profileRole" class="role-badge">Citizen</div>
            </div>

            <div class="profile-details" style="display: grid; gap: 1rem;">
                <div class="detail-item">
                    <div class="label">Status</div>
                    <div id="profileStatus" class="value">Safe</div>
                </div>
                <div class="detail-item">
                    <div class="label">Last Message</div>
                    <div id="profileLastMsg" class="value" style="font-style: italic;">...</div>
                </div>
                <div class="detail-item">
                    <div class="label">Location</div>
                    <div id="profileLocation" class="value">Unknown</div>
                </div>
            </div>

            <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                <button id="btnCloseProfile" class="btn btn-sm" style="flex: 1; background: transparent; border: 1px solid var(--glass-border);">Close</button>
                <button id="btnMessageProfile" class="btn btn-sm" style="flex: 1;">Message</button>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="modal" style="display: none;">
        <div class="modal-content card" style="text-align: center; max-width: 350px;">
            <h3 class="section-title" style="font-size: 1rem; margin-bottom: 1.5rem;">Scan to Connect</h3>
            <div id="qrcode" style="display: flex; justify-content: center; margin-bottom: 1.5rem; padding: 10px; background: white; border-radius: 8px;"></div>
            <div id="serverUrl" style="font-family: monospace; font-size: 1.1rem; margin-bottom: 1.5rem; color: var(--accent-color);"></div>
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
                Connect to the <strong>Host Wi-Fi</strong> first,<br>then scan this code or type the URL.
            </p>
            <button id="btnCloseQR" class="btn btn-sm" style="width: 100%;">Close</button>
        </div>
    </div>

    <!-- App Logic -->
    <script src="js/app.js?v=2.0"></script>
</body>
</html>